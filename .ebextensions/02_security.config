# .ebextensions/02_security.config
# AWS Elastic Beanstalk 인스턴스 보안 설정

files:
  "/tmp/apply_security_settings.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      echo "========================================="
      echo "Starting security configuration..."
      echo "========================================="

      # 1. 패스워드 복잡성 설정
      echo "[1/9] Configuring password complexity..."

      if grep -q "pam_pwquality.so" /etc/pam.d/system-auth; then
        sed -i '/pam_pwquality.so/c\password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=' /etc/pam.d/system-auth
      else
        sed -i '/password    requisite/a password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=' /etc/pam.d/system-auth
      fi

      # 2. 계정 잠금 임계값 설정
      echo "[2/9] Configuring account lockout policy..."

      # 멱등성 보장: 정확히 2줄이고 올바른 설정이면 스킵
      CURRENT_COUNT=$(grep -c "pam_tally2.so" /etc/pam.d/system-auth 2>/dev/null || echo "0")
      HAS_AUTH=$(grep -c "auth.*pam_tally2.so deny=3 unlock_time=600" /etc/pam.d/system-auth 2>/dev/null || echo "0")
      HAS_ACCOUNT=$(grep -c "account.*pam_tally2.so$" /etc/pam.d/system-auth 2>/dev/null || echo "0")

      if [ "$CURRENT_COUNT" -eq 2 ] && [ "$HAS_AUTH" -eq 1 ] && [ "$HAS_ACCOUNT" -eq 1 ]; then
        echo "  Already configured correctly (2 lines), skipping..."
      else
        echo "  Current state: total=$CURRENT_COUNT, auth=$HAS_AUTH, account=$HAS_ACCOUNT"
        echo "  Removing ALL pam_tally2 configurations..."
        # 기존 pam_tally2 설정 완전히 제거
        sed -i '/pam_tally2\.so/d' /etc/pam.d/system-auth

        # 빈 줄도 정리
        sed -i '/^$/N;/^\n$/d' /etc/pam.d/system-auth

        echo "  Adding pam_tally2 to correct positions..."
        # auth 섹션: pam_env.so가 있는 줄 다음에 추가 (정확한 패턴 매칭)
        sed -i '/^auth[[:space:]]\+required[[:space:]]\+pam_env\.so$/a auth        required      pam_tally2.so deny=3 unlock_time=600' /etc/pam.d/system-auth

        # account 섹션: pam_unix.so가 있는 줄 다음에 추가 (정확한 패턴 매칭)
        sed -i '/^account[[:space:]]\+required[[:space:]]\+pam_unix\.so$/a account     required      pam_tally2.so' /etc/pam.d/system-auth

        echo "  Done. Verifying..."
        FINAL_COUNT=$(grep -c "pam_tally2.so" /etc/pam.d/system-auth)
        echo "  pam_tally2 lines: $FINAL_COUNT (expected: 2)"

        if [ "$FINAL_COUNT" -ne 2 ]; then
          echo "  WARNING: Expected 2 lines but got $FINAL_COUNT"
        fi
      fi

      # 3. 패스워드 복잡도 설정
      echo "[3/9] Configuring password complexity requirements..."

      if [ -f /etc/security/pwquality.conf ]; then
        # 기존 설정 제거
        sed -i '/^minlen/d' /etc/security/pwquality.conf
        sed -i '/^minclass/d' /etc/security/pwquality.conf
        sed -i '/^ucredit/d' /etc/security/pwquality.conf
        sed -i '/^lcredit/d' /etc/security/pwquality.conf
        sed -i '/^dcredit/d' /etc/security/pwquality.conf
        sed -i '/^ocredit/d' /etc/security/pwquality.conf

        # 복잡도 설정 추가
        # - 최소 8자리 이상
        # - 최소 3가지 문자 클래스 사용 (대문자, 소문자, 숫자, 특수문자 중 3가지 이상)
        # - minclass=3 설정만으로 3종류 이상 강제됨
        {
          echo "# 패스워드 복잡도 설정"
          echo "minlen = 8"
          echo "minclass = 3"
        } >> /etc/security/pwquality.conf

        echo "  Set password complexity: minlen=8, minclass=3 (대/소문자, 숫자, 특수문자 중 3종류 이상)"
      fi

      # 4. 패스워드 최대 사용 기간 설정
      echo "[4/9] Configuring password max days..."

      sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   90/' /etc/login.defs

      # 5. 패스워드 최소 사용 기간 설정
      echo "[5/9] Configuring password min days..."

      sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   1/' /etc/login.defs

      # 6. Session Timeout 설정
      echo "[6/9] Configuring session timeout..."

      # /etc/profile 설정 (기존 TMOUT 관련 라인 제거 후 추가)
      sed -i '/^TMOUT=/d' /etc/profile
      sed -i '/^readonly TMOUT/d' /etc/profile
      sed -i '/^export TMOUT/d' /etc/profile
      echo "TMOUT=600" >> /etc/profile
      echo "readonly TMOUT" >> /etc/profile
      echo "export TMOUT" >> /etc/profile

      # /etc/bashrc에서 TMOUT 관련 설정 제거 (충돌 방지)
      # /etc/profile에서만 설정하므로 중복 제거
      sed -i '/^TMOUT=/d' /etc/bashrc
      sed -i '/^readonly TMOUT/d' /etc/bashrc
      sed -i '/^export TMOUT/d' /etc/bashrc

      # 7. at 파일 소유자 및 권한 설정
      echo "[7/9] Configuring at file permissions..."

      if [ -f /etc/at.allow ]; then
        chown root:root /etc/at.allow
        chmod 640 /etc/at.allow
      fi

      if [ -f /etc/at.deny ]; then
        chown root:root /etc/at.deny
        chmod 640 /etc/at.deny
      fi

      # 8. 로그온 시 경고 메시지 제공
      echo "[8/9] Configuring login banner..."

      # Amazon Linux 동적 MOTD 완전 비활성화
      if [ -d /etc/update-motd.d ]; then
        # 백업 디렉토리 생성 및 스크립트 이동
        mkdir -p /etc/update-motd.d.disabled
        mv /etc/update-motd.d/* /etc/update-motd.d.disabled/ 2>/dev/null
        echo "  Moved dynamic MOTD scripts to .disabled"
      fi

      # 기존 motd 완전 제거 (심볼릭 링크 포함)
      rm -f /etc/motd

      # 직접 파일로 생성 (echo 사용)
      {
        echo "==============================================================================="
        echo "                      AUTHORIZED ACCESS ONLY"
        echo "==============================================================================="
        echo "This system is for authorized use only. All activity is monitored and logged."
        echo "Unauthorized access attempts will be prosecuted to the fullest extent of law."
        echo "==============================================================================="
      } > /etc/motd

      # SSH 배너 설정
      if [ -f /etc/ssh/sshd_config ]; then
        # 기존 Banner 설정 제거 후 추가
        sed -i '/^Banner /d' /etc/ssh/sshd_config
        echo "Banner /etc/motd" >> /etc/ssh/sshd_config

        # SSH 서비스 재시작 (설정 적용)
        systemctl restart sshd
        echo "  Restarted SSH service"
      fi

      # PAM에서 동적 MOTD 비활성화
      if [ -f /etc/pam.d/sshd ]; then
        sed -i '/pam_motd\.so/s/^/#/' /etc/pam.d/sshd
        echo "  Disabled pam_motd in PAM configuration"
      fi

      # 9. cron 파일 소유자 및 권한 설정
      echo "[9/9] Configuring cron file permissions..."

      if [ -f /etc/cron.allow ]; then
        chown root:root /etc/cron.allow
        chmod 640 /etc/cron.allow
      fi

      if [ -f /etc/cron.deny ]; then
        chown root:root /etc/cron.deny
        chmod 640 /etc/cron.deny
      fi

      echo "========================================="
      echo "Security configuration completed!"
      echo "========================================="

      echo "[$(date)] Security settings applied successfully" >> /var/log/eb-security-config.log

commands:
  01_apply_security_settings:
    command: "/tmp/apply_security_settings.sh"
    ignoreErrors: false
